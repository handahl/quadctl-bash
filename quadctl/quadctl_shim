#!/usr/bin/env bash
# ==============================================================================
# FILE: quadctl_shim
# PATH: src/quadctl_shim
# PROJECT: quadctl
# VERSION: 11.2.0
# AUTHOR: SAC-CP (v2.1)
# DESCRIPTION: The executable shim. Bootstraps environment and routes commands.
# ==============================================================================

set -euo pipefail

# 1. RESOLVE INSTALLATION ROOT
# ------------------------------------------------------------------------------
# We resolve the physical location of the script, then determine the project root.
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do 
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Heuristic: Locate 'src' relative to the script location
if [[ -d "${SCRIPT_DIR}/src" ]]; then
    readonly INSTALL_ROOT="${SCRIPT_DIR}"
elif [[ -d "${SCRIPT_DIR}/../src" ]]; then
    readonly INSTALL_ROOT="$(dirname "${SCRIPT_DIR}")"
else
    log_err "Could not locate 'src' directory from ${SCRIPT_DIR}"
    exit 1
fi

# 2. BOOTSTRAP ENVIRONMENT
# ------------------------------------------------------------------------------
if [[ -f "${INSTALL_ROOT}/src/core/env.bash" ]]; then
    source "${INSTALL_ROOT}/src/core/env.bash"
else
    log_err "Core environment missing at ${INSTALL_ROOT}/src/core/env.bash"
    exit 1
fi

# 3. DEPENDENCY CHECK
# ------------------------------------------------------------------------------
source "${INSTALL_ROOT}/src/core/deps.bash"

# Skip heavy dependency checks for help/version/shell commands
if [[ ! "${1:-}" =~ ^(-h|--help|-v|--version|shell)$ ]]; then
    check_runtime_dependencies
fi

# 4. COMMAND ROUTING
# ------------------------------------------------------------------------------
cmd="${1:-status}"
shift || true

# Helper: Parse --type=foo or -t foo arguments
parse_filter() {
    local arg="${1:-}"
    if [[ "$arg" == --type=* ]]; then
        echo "${arg#*=}"
    elif [[ "$arg" == "-t" ]]; then
        echo "${2:-all}"
    else
        echo "all"
    fi
}

case "$cmd" in
    # --- INSPECTION & EDITING ---
    cat)
        source "${INSTALL_ROOT}/src/logic/interact.bash"
        execute_cat "${1:-missing}" "${2:-}"
        ;;
    edit)
        source "${INSTALL_ROOT}/src/logic/interact.bash"
        execute_edit "${1:-missing}" "${2:-}"
        ;;
        
    # --- CORE LOGIC ---
    tree)
        source "${INSTALL_ROOT}/src/logic/tree.bash"
        execute_tree_view
        ;;
    audit)
        source "${INSTALL_ROOT}/src/logic/audit.bash"
        execute_audit
        ;;
    status|matrix|q)
        source "${INSTALL_ROOT}/src/logic/matrix.bash"
        # Pass filtering args if present
        filter=$(parse_filter "${1:-}")
        execute_matrix_view "$filter"
        ;;
    deploy|sync)
        source "${INSTALL_ROOT}/src/logic/deploy.bash"
            # Default to dry-run if not specified, for safety
        execute_deploy "${1:-dry-run}"
        ;;
    doctor)
        source "${INSTALL_ROOT}/src/logic/doctor.bash"
        execute_doctor
        ;;
    migrate)
        # Prefix Migration Logic
        source "${INSTALL_ROOT}/src/logic/migrate.bash"
        execute_prefix_migration "$@"
        ;;
        
    # --- UTILITIES ---
    dr|daemon-reload)
        log_info "Reloading systemd user daemon..."
        systemctl --user daemon-reload
        log_success "Daemon reloaded."
        ;;
        
    # --- SYSTEM CONTROL ---
    start|stop|restart|reload|logs|enable|disable|mask|unmask)
        source "${INSTALL_ROOT}/src/logic/control.bash"
        execute_control "$cmd" "${1:-}"
        ;;
        
    # --- META ---
    help|--help|-h)
        source "${INSTALL_ROOT}/src/ui/help.bash"
        show_help
        ;;
    version|--version|-v)
        source "${INSTALL_ROOT}/src/ui/help.bash"
        show_version
        ;;
    shell)
        source "${INSTALL_ROOT}/src/logic/shell.bash"
        execute_shell
        ;;
    *)
        source "${INSTALL_ROOT}/src/ui/help.bash"
        log_err "Unknown command: $cmd"
        show_help
        exit 1
        ;;
esac